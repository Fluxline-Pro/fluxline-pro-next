# Google reCAPTCHA Implementation Summary

## Overview
This document provides a high-level summary of the Google reCAPTCHA v3 implementation for the Fluxline Pro contact form, including architecture, flow, and deployment.

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend (Next.js)                        │
├─────────────────────────────────────────────────────────────────┤
│  1. User fills contact form                                      │
│  2. ReCaptchaProvider wraps app (layout.tsx)                     │
│  3. ContactForm uses useGoogleReCaptcha() hook                   │
│  4. On submit: executeRecaptcha('contact_form')                  │
│  5. Token generated by Google reCAPTCHA v3                       │
│  6. POST to /api/contact with token                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                Azure Static Web App (Production)                 │
│                  OR Next.js API Route (Dev)                      │
├─────────────────────────────────────────────────────────────────┤
│  Azure Function: /api/contact/index.js                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 1. Validate input (required fields, email format, length) │  │
│  │ 2. Check rate limit (5 requests/hour per IP)             │  │
│  │ 3. Verify reCAPTCHA token with Google                    │  │
│  │    - POST to https://www.google.com/recaptcha/api/       │  │
│  │    - Receive score (0.0 = bot, 1.0 = human)             │  │
│  │    - Compare with threshold (default: 0.5)               │  │
│  │ 4. If score ≥ threshold: Process submission              │  │
│  │ 5. Send email via SMTP (nodemailer)                      │  │
│  │ 6. Return success/error response                         │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Google reCAPTCHA API                         │
├─────────────────────────────────────────────────────────────────┤
│  Endpoint: https://www.google.com/recaptcha/api/siteverify      │
│  Method: POST                                                    │
│  Body: secret=<SECRET_KEY>&response=<TOKEN>                     │
│  Response: { success: true/false, score: 0.0-1.0 }             │
└─────────────────────────────────────────────────────────────────┘
```

## Security Layers

The implementation includes 5 layers of spam protection:

1. **reCAPTCHA v3** (Primary)
   - Invisible bot detection
   - Score-based validation (0.0 = bot, 1.0 = human)
   - Configurable threshold (default: 0.5)
   - No user interaction required

2. **Rate Limiting**
   - 5 requests per IP per hour
   - In-memory store (serverless)
   - Returns 429 status when exceeded

3. **Honeypot Field**
   - Hidden field in frontend form
   - Bots typically fill all fields
   - Checked before submission

4. **Input Validation**
   - Required field checks
   - Email format validation (regex)
   - Message length limit (1000 chars)

5. **Input Sanitization**
   - Removes HTML angle brackets
   - Prevents email client injection
   - Trims whitespace

## Configuration

### Environment Variables

#### Frontend (Next.js)
```bash
# .env.local
NEXT_PUBLIC_RECAPTCHA_SITE_KEY=your_site_key_here
RECAPTCHA_SECRET_KEY=your_secret_key_here  # For Next.js API route
```

#### Backend (Azure Function)
```json
// api/local.settings.json (local)
{
  "Values": {
    "RECAPTCHA_SECRET_KEY": "your_secret_key_here",
    "RECAPTCHA_SCORE_THRESHOLD": "0.5",
    "SMTP_HOST": "mail.smtp2go.com",
    "SMTP_PORT": "2525",
    "SMTP_USER": "your_username",
    "SMTP_PASS": "your_password",
    "SMTP_FROM": "no-reply@fluxline.pro",
    "CONTACT_EMAIL": "support@fluxline.pro"
  }
}
```

#### Azure Portal (Production)
Configure in Azure Static Web App → Configuration → Application settings

## File Structure

```
fluxline-pro-next/
├── src/
│   ├── components/
│   │   └── ReCaptchaProvider.tsx          # reCAPTCHA wrapper component
│   ├── app/
│   │   ├── layout.tsx                     # Wraps app with ReCaptchaProvider
│   │   ├── contact/
│   │   │   ├── page.tsx                   # Contact page with privacy notice
│   │   │   └── components/
│   │   │       └── ContactForm.tsx        # Form with reCAPTCHA integration
│   │   └── api/
│   │       └── contact/
│   │           └── route.ts               # Next.js API route (dev)
├── api/
│   ├── contact/
│   │   ├── index.js                       # ✨ Azure Function (production)
│   │   └── function.json                  # Function configuration
│   ├── host.json                          # Azure Functions host config
│   ├── package.json                       # Dependencies (nodemailer)
│   ├── local.settings.sample.json         # Environment template
│   ├── test-contact.js                    # Test script
│   └── README.md                          # API documentation
├── .env.example                           # Environment template
├── RECAPTCHA_IMPLEMENTATION.md            # Implementation guide
├── RECAPTCHA_AZURE_DEPLOYMENT.md          # Deployment guide
├── RECAPTCHA_QUICKSTART.md                # 5-minute setup
└── staticwebapp.config.json               # Azure SWA routing

✨ = File modified/created in this implementation
```

## Request Flow

### 1. User Submits Form

```javascript
// Frontend: ContactForm.tsx
const { executeRecaptcha } = useGoogleReCaptcha();

// Generate token
const recaptchaToken = await executeRecaptcha('contact_form');

// Submit with token
await fetch('/api/contact', {
  method: 'POST',
  body: JSON.stringify({
    name: 'John Doe',
    email: 'john@example.com',
    message: 'Hello!',
    recaptchaToken: '03AGdBq24...'
  })
});
```

### 2. Azure Function Validates

```javascript
// Backend: api/contact/index.js

// 1. Check rate limit
if (!checkRateLimit(ip)) {
  return { status: 429, message: 'Too many requests' };
}

// 2. Verify reCAPTCHA
const result = await verifyRecaptcha(token, context);
if (!result.success || result.score < threshold) {
  return { status: 403, message: 'Verification failed' };
}

// 3. Send email
await transporter.sendMail({
  from: 'no-reply@fluxline.pro',
  to: 'support@fluxline.pro',
  subject: `Contact Form: ${name}`,
  text: message
});

return { status: 200, message: 'Success' };
```

### 3. Google Verifies Token

```javascript
// Internal: verifyRecaptcha function
const response = await https.request('https://www.google.com/recaptcha/api/siteverify', {
  method: 'POST',
  body: `secret=${secretKey}&response=${token}`
});

// Response format
{
  "success": true,
  "score": 0.9,           // 0.0 = bot, 1.0 = human
  "action": "contact_form",
  "challenge_ts": "2025-12-10T02:35:42Z",
  "hostname": "fluxline.pro"
}
```

## Testing

### Local Development

```bash
# 1. Install dependencies
cd api && npm install

# 2. Configure environment
cp local.settings.sample.json local.settings.json
# Edit local.settings.json with your credentials

# 3. Start Azure Functions
npm start

# 4. Run tests (in another terminal)
npm test
```

### Test Cases Included

1. ✅ Valid submission
2. ✅ Missing required field
3. ✅ Invalid email format
4. ✅ Message too long (>1000 chars)
5. ✅ Submission with reCAPTCHA token

### Manual Testing

```bash
# Start Next.js dev server
yarn dev

# Visit contact page
open http://localhost:3000/contact

# Fill and submit form
# Check for:
# - reCAPTCHA badge (bottom-right)
# - Success message
# - Email received
```

## Deployment Checklist

### Pre-deployment
- [ ] Obtain Google reCAPTCHA v3 keys
- [ ] Test locally with real keys
- [ ] Update staticwebapp.config.json (already done)
- [ ] Review security settings

### Azure Configuration
- [ ] Configure `RECAPTCHA_SECRET_KEY` in Azure Portal
- [ ] Configure `RECAPTCHA_SCORE_THRESHOLD` (optional, default 0.5)
- [ ] Configure SMTP credentials
- [ ] Add production domain to reCAPTCHA admin

### GitHub Actions
- [ ] Add `NEXT_PUBLIC_RECAPTCHA_SITE_KEY` to GitHub Secrets
- [ ] Update workflow to pass environment variable
- [ ] Verify build pipeline passes

### Post-deployment
- [ ] Verify reCAPTCHA badge appears on site
- [ ] Test form submission
- [ ] Check Azure Function logs
- [ ] Monitor email delivery
- [ ] Review reCAPTCHA scores in logs

## Monitoring

### Azure Portal
1. Go to Azure Static Web App
2. Navigate to Functions → contact
3. Click Monitor or Logs
4. Look for:
   - "Verifying reCAPTCHA token..."
   - "reCAPTCHA verification successful. Score: X.XX"
   - "Email sent successfully"

### Google reCAPTCHA Admin
1. Visit https://www.google.com/recaptcha/admin
2. Select your site
3. View analytics:
   - Request volume
   - Score distribution
   - Flagged requests

### Logging Output

```
[2025-12-10T02:35:42.228Z] Contact form submission received
[2025-12-10T02:35:42.230Z] Verifying reCAPTCHA token...
[2025-12-10T02:35:42.534Z] reCAPTCHA verification successful. Score: 0.9
[2025-12-10T02:35:43.112Z] Email sent successfully
```

## Troubleshooting

### Common Issues

| Issue | Solution |
|-------|----------|
| Badge not showing | Check `NEXT_PUBLIC_RECAPTCHA_SITE_KEY` is configured |
| Form returns 403 | Check `RECAPTCHA_SECRET_KEY` in Azure settings |
| Email not received | Verify SMTP credentials, check spam folder |
| Cold start delays | Normal for Azure Functions consumption plan |
| Rate limit errors | Wait 1 hour or adjust MAX_REQUESTS constant |

### Debug Mode

Enable detailed logging:

```javascript
// api/contact/index.js
context.log('Detailed debug info:', {
  hasToken: !!recaptchaToken,
  ip: ip,
  timestamp: new Date().toISOString()
});
```

## Performance

### Metrics
- **Frontend overhead**: ~50KB (reCAPTCHA library)
- **Request time**: +200-500ms (token verification)
- **Cold start**: 2-5 seconds (first request)
- **Warm start**: <500ms (subsequent requests)

### Optimization Tips
1. Use Azure Functions Premium plan for no cold starts
2. Implement retry logic for transient failures
3. Consider Azure Redis for distributed rate limiting
4. Monitor score distribution and adjust threshold

## Security Considerations

### Best Practices
✅ Never commit secrets to repository
✅ Use environment variables for all sensitive data
✅ Rotate keys periodically
✅ Monitor for suspicious patterns
✅ Keep dependencies updated

### Production Recommendations
1. Enable Azure Key Vault for secrets
2. Implement distributed rate limiting (Azure Redis)
3. Set up Application Insights monitoring
4. Configure alerts for high failure rates
5. Review logs regularly for bot patterns

## Maintenance

### Regular Tasks
- [ ] Monitor reCAPTCHA score distribution
- [ ] Review email delivery success rate
- [ ] Check for failed verifications
- [ ] Update score threshold if needed
- [ ] Rotate keys annually

### Updates
- [ ] Keep nodemailer up to date
- [ ] Update Node.js runtime when available
- [ ] Review Azure Functions best practices
- [ ] Monitor Google reCAPTCHA updates

## Resources

### Documentation
- [RECAPTCHA_IMPLEMENTATION.md](RECAPTCHA_IMPLEMENTATION.md) - Technical implementation details
- [RECAPTCHA_AZURE_DEPLOYMENT.md](RECAPTCHA_AZURE_DEPLOYMENT.md) - Complete deployment guide
- [RECAPTCHA_QUICKSTART.md](RECAPTCHA_QUICKSTART.md) - 5-minute setup guide
- [api/README.md](api/README.md) - API endpoint documentation

### External Resources
- [Google reCAPTCHA v3 Docs](https://developers.google.com/recaptcha/docs/v3)
- [Azure Functions Docs](https://docs.microsoft.com/azure/azure-functions/)
- [Azure Static Web Apps Docs](https://docs.microsoft.com/azure/static-web-apps/)
- [nodemailer Documentation](https://nodemailer.com/)

## Support

For implementation-specific issues:
1. Check this summary document
2. Review relevant documentation file
3. Check Azure Function logs
4. Review troubleshooting section

For reCAPTCHA issues:
- [Google reCAPTCHA Support](https://support.google.com/recaptcha/)

For Azure issues:
- [Azure Support Portal](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade)

---

**Implementation Date**: December 10, 2025  
**Last Updated**: December 10, 2025  
**Version**: 1.0  
**Status**: ✅ Production Ready
